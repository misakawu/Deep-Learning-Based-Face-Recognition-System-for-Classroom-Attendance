<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>添加信息</title>
<style>
    body{
        background: lightblue;
        text-align: center;
    }
    h1{
        font-size: 30px;
        padding-top: 30px;
    }
    label,input{
        font-size: 20px;
       /* border-top: 20px;             padding-top: 20px;内边距*/
        margin-top: 15px;/*外边距*/
        width: 180px;   /*输入框长度*/
   }
    button{         /*控制按钮位置大小及间距*/
        font-size: 25px;
        margin-left: 60px;
        margin-right: -20px;
        /*border-radius: 10px;*/
        color: deepskyblue;
    }

    .left{
        width: 50%;
        float: left;/* 可将此句改为position:absolute;left:0; */
    }
    .right{
        width: 50%;
        float:right;/* 可将此句改为position:absolute;left:50%; */
    }

</style>
</head>
<body>
    <h1>添加学生信息</h1>
    <div class="left">
        <h2>请在下列信息栏填入学生的基本信息</h2>
        <form id="StuInfo" action="/add/" method="post">
            {% csrf_token %}
            <label>学生姓名:</label>
            <input type="text" name="stuname" required autofocus id="name"><br>
            <label>学生学号:</label>
            <input type="number" name="stuid" required autofocus id="stuid"><br>
        </form><br>

        <p>
            <button id="localsub">选择本地图片并提交</button>
        </p>

        <button type="submit" id="sub">摄像头录入并提交</button>
        <p style="font-size: 20px; color: red; padding-left: 60px" id="err">
                {% if err %}
                    {{ err }}
                {% endif %}
        </p>
        <p style="font-size: 20px; color: red; padding-left: 60px" id="succ">
                {% if success %}
                    {{ success }}
                {% endif %}
        </p>

        <div style="width: 100%;float:left;">
           <button style="width: 120px; font-size: 20px;">
           <a href="/welcome/" style="text-decoration: none;">返回主页面</a>
           </button>
        </div>
    </div>

    <div class="right">
        <h2>所有学生信息一览</h2>
        <table id="stu-table" border="1" align="center"style="border-collapse: collapse; width: 500px;max-height:700px;overflow: auto;overflow-y: scroll;">
            <tr>
                <th onclick="sortTable(0)">
                    <label id="id-up" hidden="hidden">↑</label>
                    <label id="id-down">↓</label>
                    学生编号
                </th>
                <th>学生姓名</th>
                <th>学生学号</th>
            </tr>
                {% for s in info %}
            <tr>
                <td id="id">  {{ s.id }}  </td>
                <td>  {{ s.stuname }}  </td>
                <td>  {{ s.stuid }}  </td>
            </tr>
                {% endfor %}

        </table> <br>
    </div>


</body>

<script>
    var able_for_next = true;
    document.getElementById('sub').addEventListener('click', addface);
    document.getElementById('localsub').addEventListener('click',addfacelocal)
    function addfacelocal(event) {
        event.preventDefault(); // 阻止表单默认提交行为
        if(able_for_next) {
            able_for_next=false;
            const stuname = document.getElementById('name').value;
            const stuid = document.getElementById('stuid').value;
            if (stuname.length === 0 || stuid === undefined) {
                alert('请输入全部信息')
                return
            }
            sendHttp(JSON.stringify({'stuid': stuid, 'local': true}));

        }
    }

    function addface(event) {
        event.preventDefault(); // 阻止表单默认提交行为

        if(able_for_next){
            able_for_next=false;
            const stuname = document.getElementById('name').value;
            const stuid = document.getElementById('stuid').value;
            if (stuname.length === 0 || stuid === undefined) {
                alert('请输入全部信息')
                return
            }
            sendHttp(JSON.stringify({'stuid': stuid, 'local': ''}))
        }
    }

    function sendHttp(data){
        const Http=new XMLHttpRequest();
        const url='http://127.0.0.1:8080/add/face'
        Http.open("POST",url,true);
        Http.setRequestHeader('Content-Type', 'application/json');
        const csrfToken = "{{ csrf_token }}";
        Http.setRequestHeader("X-CSRFToken", csrfToken);
        Http.onload=function  () {
            able_for_next =true;
            if (Http.status >= 200 && Http.status < 300) {
                const data=JSON.parse(Http.response);
                console.log(data);
                if(data.err)
                {
                    document.getElementById('err').innerText=data.err
                    return;
                }
                document.getElementById('err').innerText=""
                document.getElementById('StuInfo').submit()

            } else {
                console.error('Request failed:', Http.statusText);
            }
        };
        Http.send(data);
    }


    function sortTable(n) {
        var uplable = document.getElementById("id-up");
        var downlable = document.getElementById("id-down");
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("stu-table");

        switching = true;
        dir = "asc";

        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                if (dir === "asc") {
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (dir === "desc") {
                    if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount === 0 && dir === "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
        if (dir==="asc") {
            uplable.hidden=true;
            downlable.hidden=false;
        }else {
            uplable.hidden=false;
            downlable.hidden=true;
        }
    }
</script>
</html>