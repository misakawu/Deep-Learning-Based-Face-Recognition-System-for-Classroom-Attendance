<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type"content="text/html; charset=UTF-8" />
<style type="text/css">
    .main {
        margin: 20px auto;
        width: 500px;
        text-align: center;
    }
    body{
        background: lightblue;
        text-align: center;
    }
    label{
        font-size: 20px;
       /* border-top: 20px;             padding-top: 20px;内边距*/
        margin-top: 15px;/*外边距*/
        width: 180px;   /*输入框长度*/
   }
    .info {
        text-align: center;
        margin: 20px auto;
        width: 500px;
    }
    table, th, td {
        border: 1px solid black;
        border-collapse: collapse;
        padding: 8px;
        text-align: center;
    }
</style>
<title>签到</title>
</head>

<body>
    <div id="loadingModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
        <div style="position:absolute; left:50%; top:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:5px;">
            <p>正在获取位置信息，请稍候...</p>
        </div>
        <div id="allmap"></div>
    </div>
    <div class="info">
        <label style="color: red" id="msg">
        </label>
    </div>

    <p><label>课程考勤</label></p>
    <table border="1" align="center"style="border-collapse: collapse; width: 600px">
        <tr>
            <th>课程名称</th>
            <th>考勤时间</th>
            <th style="width: 60px">状态</th>
            <th style="width: 50px">&nbsp;</th>
        </tr>
        {% for req in requests %}
            <tr>
                <td>  {{ req.courseid__coursename }}  </td>
                <td>  {{ req.starttime }} <br>~<br> {{ req.endtime }} </td>
                {% if req.state == '未开始' %}
                     <td>
                        <label style="font-size:15px;background-color: grey;border-radius:5px 5px 5px 5px;">未开始</label>
                    </td>
                    <td>&nbsp;</td>
                {% else %}<td>
                    <label style="font-size:15px;background-color: green;color: white;border-radius:5px 5px 5px 5px;">正在进行</label>
                    </td>
                    <td><button style="font-size: 15px" onclick="attend({{ req.id }})">考勤</button></td>
                {% endif %}
            </tr>
        {% endfor %}
    </table><br>

	<div>
        <table width="500" align="center" cellspacing="0" cellpadding="6" id="tab">
            <caption>考勤记录表</caption>
            <table id="log-table" border="1" align="center"style="border-collapse: collapse; width: 700px">
                <tr>
                    <th onclick="sortTable(0)">
                        <label id="id-up">↑</label>
                        <label id="id-down" hidden="hidden">↓</label>
                        id
                    </th>
                    <th>课程</th>
                    <th>时间</th>
                </tr>

                    {% for log in logs %}
                <tr>
                    <td >  {{ log.id }}  </td>
                    <td>  {{ log.requestid__courseid__coursename }}  </td>
                    <td>  {{ log.attendtime }}  </td>
                </tr>
                    {% endfor %}
            </table>
            <tbody id="records"></tbody>
         </table>
	</div><br>

    <a href="/welcome" >
        <button style="width: 120px; font-size: 20px; color: deepskyblue;">回到主界面</button>
    </a>
</body>
<script type="text/javascript">

    if ( window.history.replaceState ) {
        window.history.replaceState(null, null, window.location.href );
    }

    function sortTable(n) {
        var uplable = document.getElementById("id-up");
        var downlable = document.getElementById("id-down");
        var table, rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
        table = document.getElementById("log-table");

        switching = true;
        dir = "asc";

        while (switching) {
            switching = false;
            rows = table.rows;
            for (i = 1; i < (rows.length - 1); i++) {
                shouldSwitch = false;
                x = rows[i].getElementsByTagName("TD")[n];
                y = rows[i + 1].getElementsByTagName("TD")[n];
                if (dir === "asc") {
                    if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                } else if (dir === "desc") {
                    if (x.innerHTML.toLowerCase() < y.innerHTML.toLowerCase()) {
                        shouldSwitch = true;
                        break;
                    }
                }
            }
            if (shouldSwitch) {
                rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                switching = true;
                switchcount++;
            } else {
                if (switchcount === 0 && dir === "asc") {
                    dir = "desc";
                    switching = true;
                }
            }
        }
        if (dir==="asc") {
            uplable.hidden=true;
            downlable.hidden=false;
        }else {
            uplable.hidden=false;
            downlable.hidden=true;
        }
    }
    var ablefornext = true;
    function attend(reqid) {
        if (!ablefornext)
            return;
        ablefornext = false;
        const Http = new XMLHttpRequest();
        const url = 'http://127.0.0.1:8080/attend/'
        Http.open("POST", url, true);
        Http.setRequestHeader('Content-Type', 'application/json');
        const csrfToken = "{{ csrf_token }}";
        Http.setRequestHeader("X-CSRFToken", csrfToken);

        Http.onload = function () {
            const msglable = document.getElementById('msg');
            const data = JSON.parse(Http.response);
            if (Http.status >= 200 && Http.status < 300) {
                if (data.err) {
                    msglable.innerText = data.err
                    console.log(data.err)
                } else if (data.succ)
                    location.reload();
            } else {
                alert(data.err)
            }
            ablefornext = true;
        }

        Http.send(JSON.stringify({'reqid': reqid}));
    }
</script>

</html>